<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Archivos - BlockHub</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital,wght@0,100..700;1,100..700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #013EFB;
            --secondary-color: #90F209;
            --dark-navy: #01112B;
            --deep-black: #000000;
            --almost-black: #0a0a0a;
            --dark-charcoal: #1a1a1a;
            --light-gray: #EBEBEB;
            --glass-bg: rgba(235, 235, 235, 0.1);
            --glass-border: rgba(235, 235, 235, 0.2);
            --dark-glass: rgba(1, 17, 43, 0.3);
            --text-light: rgba(235, 235, 235, 0.95);
            --text-muted: rgba(235, 235, 235, 0.75);
            --code-bg: rgba(255, 255, 255, 0.1);
            --sidebar-bg: rgba(1, 17, 43, 0.3);
            --editor-bg: rgba(1, 17, 43, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto Mono', monospace;
            background: linear-gradient(135deg, var(--deep-black) 0%, var(--almost-black) 25%, var(--dark-charcoal) 40%, var(--dark-navy) 70%, var(--primary-color) 100%);
            min-height: 100vh;
            overflow-x: hidden;
            color: var(--text-light);
        }

        /* Animated Background */
        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: linear-gradient(135deg, var(--deep-black) 0%, var(--almost-black) 20%, var(--dark-charcoal) 35%, var(--dark-navy) 55%, var(--primary-color) 75%, var(--secondary-color) 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        /* Floating cubes animation */
        .bg-cube {
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 12px;
            opacity: 0.4;
            animation: bgCubeFloat 8s ease-in-out infinite;
        }

        .bg-cube:nth-child(1) {
            top: 10%;
            left: 15%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            animation-delay: 0s;
            box-shadow: 0 8px 25px rgba(1, 62, 251, 0.3);
        }

        .bg-cube:nth-child(2) {
            top: 60%;
            right: 20%;
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            animation-delay: 2s;
            box-shadow: 0 8px 25px rgba(144, 242, 9, 0.3);
            width: 80px;
            height: 80px;
        }

        .bg-cube:nth-child(3) {
            bottom: 20%;
            left: 25%;
            background: linear-gradient(135deg, var(--dark-navy), var(--primary-color));
            animation-delay: 4s;
            box-shadow: 0 8px 25px rgba(1, 17, 43, 0.3);
            width: 50px;
            height: 50px;
        }

        @keyframes bgCubeFloat {
            0%, 100% { 
                transform: translateY(0px) rotate(0deg) scale(1);
                opacity: 0.4;
            }
            25% { 
                transform: translateY(-15px) rotate(45deg) scale(1.1);
                opacity: 0.6;
            }
            50% { 
                transform: translateY(-30px) rotate(90deg) scale(0.9);
                opacity: 0.3;
            }
            75% { 
                transform: translateY(-15px) rotate(135deg) scale(1.05);
                opacity: 0.5;
            }
        }

        /* Glassmorphism Components */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .glass-dark {
            background: var(--dark-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Layout */
        .container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 0;
        }

        /* Navigation */
        .navbar {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            width: 90%;
            max-width: 1200px;
            border-radius: 20px;
            padding: 12px 24px;
            transition: all 0.3s ease;
            animation: slideDown 1s ease;
        }

        @keyframes slideDown {
            from { transform: translateX(-50%) translateY(-100px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-logo .logo-image {
            height: auto;
            width: auto;
            max-width: 150px;
            object-fit: contain;
            transition: transform 0.3s ease, filter 0.3s ease;
        }

        .nav-logo .logo-image:hover {
            transform: scale(1.05);
            filter: brightness(1.1);
        }

        .nav-menu {
            display: flex;
            list-style: none;
            gap: 2rem;
        }

        .nav-menu a {
            color: var(--text-light);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            position: relative;
        }

        .nav-menu a::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 0;
            width: 0;
            height: 2px;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            transition: width 0.3s ease;
        }

        .nav-menu a:hover::after {
            width: 100%;
        }

        .nav-menu a:hover {
            color: white;
            transform: translateY(-2px);
        }

        /* Main Editor Area */
        .editor-container {
            display: flex;
            flex: 1;
            min-height: 0;
            padding-top: 100px; /* Space for fixed navbar */
        }

        /* Sidebar */
        .sidebar {
            width: 320px;
            background: var(--sidebar-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-right: 1px solid var(--glass-border);
            padding: 2rem;
            overflow-y: auto;
            box-shadow: 4px 0 6px rgba(0, 0, 0, 0.05);
            margin: 1rem 0 1rem 1rem;
            border-radius: 20px;
        }

        .file-section {
            margin-bottom: 2rem;
        }

        .file-section h3 {
            color: var(--secondary-color);
            margin-bottom: 1rem;
            font-size: 1.1rem;
            background: rgba(144, 242, 9, 0.15);
            padding: 0.75rem 1rem;
            border-radius: 15px;
            border-left: 4px solid var(--secondary-color);
            font-weight: 600;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .file-input-group {
            margin-bottom: 1rem;
        }

        .file-input-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-light);
            font-weight: 500;
        }

        .file-input-group input, .file-input-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1.5px solid var(--glass-border);
            border-radius: 15px;
            background: var(--glass-bg);
            color: var(--text-light);
            font-family: 'Roboto Mono', monospace;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .file-input-group input:focus, .file-input-group select:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(144, 242, 9, 0.2);
            background: rgba(255, 255, 255, 0.1);
        }

        .file-input-group input::placeholder {
            color: var(--text-muted);
        }

        /* File List */
        .file-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .file-item {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1.5px solid rgba(0, 0, 0, 0.1);
        }

        .file-item:hover {
            border-color: var(--secondary-color);
            background: rgba(144, 242, 9, 0.15);
            transform: translateX(2px);
        }

        .file-item.active {
            border-color: var(--secondary-color);
            background: rgba(144, 242, 9, 0.25);
            box-shadow: 0 2px 8px rgba(144, 242, 9, 0.3);
        }

        .file-name {
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 0.25rem;
        }

        .file-hash {
            font-size: 0.8rem;
            color: var(--text-muted);
            word-break: break-all;
        }

        /* Commit History Styles */
        .commit-history-list {
            max-height: 350px;
            overflow-y: auto;
        }

        .commit-item {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1.5px solid rgba(0, 0, 0, 0.1);
            border-left: 4px solid transparent;
        }

        .commit-item:hover {
            border-color: var(--secondary-color);
            background: rgba(144, 242, 9, 0.15);
            transform: translateX(2px);
        }

        .commit-item.active {
            border-color: var(--secondary-color);
            background: rgba(144, 242, 9, 0.25);
            box-shadow: 0 2px 8px rgba(144, 242, 9, 0.3);
            transform: translateX(4px);
        }

        .commit-item.pending {
            border-left-color: #ffc107;
        }

        .commit-item.approved {
            border-left-color: #28a745;
        }

        .commit-item.rejected {
            border-left-color: #dc3545;
        }

        .commit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.3rem;
        }

        .commit-message {
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 0.2rem;
            font-size: 0.9rem;
        }

        .commit-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .commit-status {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .commit-status.pending {
            background: #fff3cd;
            color: #856404;
        }

        .commit-status.approved {
            background: #d4edda;
            color: #155724;
        }

        .commit-status.rejected {
            background: #f8d7da;
            color: #721c24;
        }

        .repo-name {
            font-weight: bold;
            color: var(--secondary-color);
            font-size: 0.9rem;
        }

        /* Main Editor */
        .editor-area {
            flex: 1;
            background: var(--editor-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 2rem;
            display: flex;
            flex-direction: column;
            margin: 1rem;
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .current-file {
            color: var(--secondary-color);
            font-weight: 600;
            background: rgba(144, 242, 9, 0.2);
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            border: 1px solid rgba(144, 242, 9, 0.3);
            font-size: 1.1rem;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .editor-actions {
            display: flex;
            gap: 1rem;
        }

        /* Code Editor */
        .code-editor {
            flex: 1;
            min-height: 0;
            position: relative;
        }

        .code-textarea {
            width: 100%;
            height: 100%;
            min-height: 500px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid var(--glass-border);
            border-radius: 20px;
            padding: 2rem;
            color: var(--text-light);
            font-family: 'Roboto Mono', monospace;
            font-size: 14px;
            line-height: 1.6;
            resize: none;
            outline: none;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .code-textarea:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(144, 242, 9, 0.2);
            background: rgba(0, 0, 0, 0.4);
        }

        .code-textarea::placeholder {
            color: var(--text-muted);
        }

        /* Buttons */
        .btn {
            padding: 16px 32px;
            border-radius: 50px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            font-family: 'Roboto Mono', monospace;
            font-size: 1rem;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: var(--light-gray);
            box-shadow: 0 10px 30px rgba(1, 62, 251, 0.4);
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .btn-primary:hover::before {
            left: 100%;
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(1, 62, 251, 0.5), 0 0 30px rgba(144, 242, 9, 0.3);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-light);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(144, 242, 9, 0.1);
            border-color: var(--secondary-color);
            transform: translateY(-2px);
        }

        .btn-success {
            background: linear-gradient(45deg, #28a745, var(--secondary-color));
            color: white;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.9rem;
            border-radius: 25px;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Status Messages */
        .status-message {
            padding: 1rem;
            border-radius: 15px;
            margin: 1rem 0;
            font-weight: 500;
            border: 2px solid;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .status-success {
            background: rgba(40, 167, 69, 0.2);
            border-color: rgba(40, 167, 69, 0.5);
            color: #28a745;
        }

        .status-error {
            background: rgba(220, 53, 69, 0.2);
            border-color: rgba(220, 53, 69, 0.5);
            color: #dc3545;
        }

        .status-info {
            background: rgba(144, 242, 9, 0.2);
            border-color: rgba(144, 242, 9, 0.5);
            color: var(--secondary-color);
        }

        .status-warning {
            background: rgba(255, 193, 7, 0.2);
            border-color: rgba(255, 193, 7, 0.5);
            color: #ffc107;
        }

        /* Loading Spinner */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(144, 242, 9, 0.3);
            border-radius: 50%;
            border-top-color: var(--secondary-color);
            animation: spin 1s ease-in-out infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .editor-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                max-height: 300px;
                border-right: none;
                border-bottom: 1px solid var(--glass-border);
            }

            .editor-area {
                margin: 0.5rem;
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 1rem;
                flex-direction: column;
                gap: 1rem;
            }

            .header-brand {
                flex-direction: column;
                gap: 0.5rem;
                text-align: center;
            }

            .header-logo {
                height: 35px;
            }

            .header h1 {
                font-size: 1.5rem;
            }
            
            .sidebar {
                padding: 1rem;
            }

            .editor-area {
                margin: 0.25rem;
                padding: 1rem;
            }
            
            .editor-actions {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .btn {
                width: 100%;
            }

            .code-textarea {
                min-height: 400px;
                padding: 1rem;
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <div class="bg-animation">
        <div class="bg-cube"></div>
        <div class="bg-cube"></div>
        <div class="bg-cube"></div>
    </div>
    
    <!-- Navigation -->
    <nav class="navbar glass">
        <div class="nav-container">
            <div class="nav-logo">
                <img src="src/assets/BLANCO.png" alt="BlockHub Logo" class="logo-image">
            </div>
            <ul class="nav-menu">
                <li><a href="index.html">Inicio</a></li>
                <li><a href="conectar-wallet.html">Wallet</a></li>
                <li><a href="editor-archivos.html" style="color: var(--secondary-color);">Editor</a></li>
                <li><a href="colaboradores.html">Colaboradores</a></li>
            </ul>
        </div>
    </nav>
    
    <div class="container">

        <div class="editor-container">
            <!-- Sidebar -->
            <div class="sidebar glass-dark">
                <div class="file-section">
                    <h3>üìÅ Nuevo Archivo</h3>
                    
                    <div class="file-input-group">
                        <label for="fileName">Nombre del archivo:</label>
                        <input type="text" id="fileName" placeholder="mi-archivo.js" />
                    </div>
                    
                    <div class="file-input-group">
                        <label for="fileType">Tipo de archivo:</label>
                        <select id="fileType">
                            <option value="javascript">JavaScript (.js)</option>
                            <option value="typescript">TypeScript (.ts)</option>
                            <option value="solidity">Solidity (.sol)</option>
                            <option value="json">JSON (.json)</option>
                            <option value="markdown">Markdown (.md)</option>
                            <option value="text">Texto (.txt)</option>
                            <option value="html">HTML (.html)</option>
                            <option value="css">CSS (.css)</option>
                        </select>
                    </div>
                    
                    <button id="createFileBtn" class="btn btn-primary" style="width: 100%;">
                        Crear Archivo
                    </button>
                </div>

                <div class="file-section">
                    <h3>üìã Historial de Commits</h3>
                    <div id="commitHistoryHeader" style="margin-bottom: 1rem; display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span id="repositoryName" class="repo-name"></span>
                            <button class="btn btn-small btn-secondary" onclick="refreshCommitHistory()" id="refreshHistoryBtn">
                                üîÑ Actualizar
                            </button>
                        </div>
                    </div>
                    <div id="commitList" class="commit-history-list">
                        <div style="text-align: center; color: var(--text-muted); padding: 2rem;">
                            üìù No hay commits disponibles<br>
                            <small>Los commits aparecer√°n aqu√≠ cuando est√©s en modo commit</small>
                        </div>
                    </div>
                </div>

                <div class="file-section">
                    <h3>üîó Cargar por Hash</h3>
                    <div class="file-input-group">
                        <label for="ipfsHash">Hash IPFS:</label>
                        <input type="text" id="ipfsHash" placeholder="Qm..." />
                    </div>
                    <button id="loadFileBtn" class="btn btn-secondary" style="width: 100%;">
                        Cargar Archivo
                    </button>
                    <button id="testConnBtn" class="btn btn-secondary" style="width: 100%; margin-top: 0.5rem; font-size: 0.8rem;">
                        üîç Probar Conectividad IPFS
                    </button>
                </div>

                <div class="file-section">
                    <h3>‚õìÔ∏è Blockchain</h3>
                    <div id="web3Status" class="status-message status-info" style="font-size: 0.9rem; padding: 0.5rem;">
                        üîç Verificando conexi√≥n...
                    </div>

                    <button id="collaboratorsBtn" class="btn btn-secondary" style="width: 100%; margin-top: 0.5rem; background: linear-gradient(45deg, #00ffaa, #00aa88); color: #000;" onclick="goToCollaborators()">
                        ü§ù Colaboradores
                    </button>
                    <button id="backToWalletBtn" class="btn btn-secondary" style="width: 100%; margin-top: 0.5rem; background: linear-gradient(45deg, #90F209, #00aa00); color: #000;" onclick="handleBackToWallet(event)">
                        ‚Üê Volver a Wallet
                    </button>
                </div>
            </div>

            <!-- Main Editor -->
            <div class="editor-area glass">
                <div class="editor-header">
                    <div class="current-file" id="currentFileName">Nuevo archivo</div>
                    <div class="editor-actions">
                        <button id="saveFileBtn" class="btn btn-success" disabled>
                            üíæ Guardar en IPFS
                        </button>
                        <button id="createRepoBtn" class="btn btn-primary" disabled>
                            üöÄ Crear Repositorio
                        </button>
                        <button id="newFileBtn" class="btn btn-secondary">
                            üìÑ Nuevo
                        </button>
                    </div>
                </div>

                <div id="statusMessage" style="display: none;"></div>

                <div class="code-editor">
                    <textarea 
                        id="codeEditor" 
                        class="code-textarea" 
                        placeholder="// Escribe tu c√≥digo aqu√≠...
// Este archivo se guardar√° en IPFS usando Pinata
console.log('¬°Hola BlockHub!');"
                    ></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- Pinata Configuration -->
    <script src="pinata-config.js"></script>
    
    <!-- Web3 and Contract Integration -->
    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="web3-contract-integration.js"></script>
    
    <script>

        // Variables globales
        let currentFileHash = null;
        let currentFileName = 'nuevo-archivo.js';
        let savedFiles = JSON.parse(localStorage.getItem('blockhub_files') || '[]');
        let web3Connected = false;
        let lastRepositoryResult = null;

        // Variable global para almacenar el hash actual (accesible desde consola del navegador)
        window.BLOCKHUB_CURRENT_FILE_HASH = null;
        window.BLOCKHUB_LAST_REPOSITORY = null;

        // DOM Elements
        const fileNameInput = document.getElementById('fileName');
        const fileTypeSelect = document.getElementById('fileType');
        const createFileBtn = document.getElementById('createFileBtn');
        const fileList = document.getElementById('fileList');
        const ipfsHashInput = document.getElementById('ipfsHash');
        const loadFileBtn = document.getElementById('loadFileBtn');
        const currentFileNameEl = document.getElementById('currentFileName');
        const saveFileBtn = document.getElementById('saveFileBtn');
        const createRepoBtn = document.getElementById('createRepoBtn');
        const newFileBtn = document.getElementById('newFileBtn');
        const codeEditor = document.getElementById('codeEditor');
        const statusMessage = document.getElementById('statusMessage');
        const testConnBtn = document.getElementById('testConnBtn');
        const web3Status = document.getElementById('web3Status');

        // Utility Functions
        function showStatus(message, type = 'info') {
            statusMessage.textContent = message;
            statusMessage.className = `status-message status-${type}`;
            statusMessage.style.display = 'block';
            
            if (type !== 'error') {
                setTimeout(() => {
                    statusMessage.style.display = 'none';
                }, 5000);
            }
        }

        // Web3 Functions - Simplified version that assumes connection exists
        async function checkWeb3Connection() {
            try {
                // Check if Web3 is already initialized from wallet page
                if (typeof window.ethereum === 'undefined') {
                    throw new Error('MetaMask no detectado');
                }

                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts.length === 0) {
                    throw new Error('No hay cuentas conectadas');
                }

                // Initialize BlockHub Web3 service if needed
                if (window.blockHubWeb3) {
                    await window.blockHubWeb3.initializeWeb3();
                    web3Connected = true;
                    
                    const accountInfo = window.blockHubWeb3.getAccountInfo();
                    web3Status.innerHTML = `üîó Conectado: ${window.blockHubWeb3.formatAddress(accountInfo.account)}`;
                    web3Status.className = 'status-message status-success';
                    
                    // Habilitar bot√≥n de crear repositorio si hay archivo
                    if (currentFileHash) {
                        createRepoBtn.disabled = false;
                    }
                    
                    showStatus('‚úÖ Wallet ya conectado desde p√°gina anterior', 'success');
                    return true;
                }
                
                throw new Error('Servicio BlockHub Web3 no disponible');
                
            } catch (error) {
                console.error('Error verificando Web3:', error);
                web3Status.innerHTML = `‚ùå ${error.message}`;
                web3Status.className = 'status-message status-error';
                
                // Show user-friendly message suggesting to go back to wallet page
                if (error.message.includes('No hay cuentas conectadas') || error.message.includes('MetaMask no detectado')) {
                    showStatus('‚ö†Ô∏è Wallet no conectado. Ve a la p√°gina de Wallet para conectar primero.', 'warning');
                } else {
                    showStatus(`Error verificando conexi√≥n: ${error.message}`, 'error');
                }
                return false;
            }
        }

        async function viewUserRepositories() {
            if (!web3Connected) {
                showStatus('Primero conecta tu wallet', 'error');
                return;
            }

            try {
                viewReposBtn.disabled = true;
                viewReposBtn.innerHTML = '<span class="loading"></span>Cargando...';
                
                const repositories = await window.blockHubWeb3.getUserRepositories();
                
                if (repositories.length === 0) {
                    showStatus('No tienes repositorios creados a√∫n', 'info');
                    return;
                }
                
                // Mostrar repositorios en consola
                console.log('üìö Tus repositorios:', repositories);
                
                // Crear modal o ventana emergente con los repositorios
                const repoList = repositories.map(repo => 
                    `üìÅ ${repo.name} (Token ID: ${repo.tokenId})\n   IPFS: ${repo.ipfsCID}`
                ).join('\n\n');
                
                alert(`Tus Repositorios:\n\n${repoList}\n\nVer consola para m√°s detalles.`);
                
                showStatus(`Se encontraron ${repositories.length} repositorios`, 'success');
                
            } catch (error) {
                console.error('Error obteniendo repositorios:', error);
                showStatus(`Error obteniendo repositorios: ${error.message}`, 'error');
            } finally {
                viewReposBtn.disabled = false;
                viewReposBtn.innerHTML = 'üìö Ver Mis Repositorios';
            }
        }

        async function createBlockchainRepository() {
            if (!web3Connected) {
                const connected = await checkWeb3Connection();
                if (!connected) {
                    showStatus('‚ùå Wallet no conectado. Ve a la p√°gina de Wallet primero.', 'error');
                    return;
                }
            }

            if (!currentFileHash) {
                showStatus('Primero debes guardar el archivo en IPFS', 'error');
                return;
            }

            try {
                createRepoBtn.disabled = true;
                createRepoBtn.innerHTML = '<span class="loading"></span>Creando Repositorio...';
                
                showStatus('üöÄ Creando repositorio en blockchain...', 'info');
                
                // Usar el nombre del archivo como nombre del repositorio
                const repoName = currentFileName.replace(/\.[^/.]+$/, ""); // Remover extensi√≥n
                
                const result = await window.blockHubWeb3.createRepository(repoName, currentFileHash);
                
                lastRepositoryResult = result;
                window.BLOCKHUB_LAST_REPOSITORY = result;
                
                // Guardar informaci√≥n del repositorio en localStorage
                const repoInfo = {
                    name: repoName,
                    ipfsCID: currentFileHash,
                    tokenId: result.tokenId,
                    transactionHash: result.transactionHash,
                    createdAt: Date.now(),
                    fileName: currentFileName
                };
                
                const savedRepos = JSON.parse(localStorage.getItem('blockhub_repositories') || '[]');
                savedRepos.unshift(repoInfo);
                localStorage.setItem('blockhub_repositories', JSON.stringify(savedRepos));
                
                // Mostrar informaci√≥n detallada del resultado
                console.log('üéâ Repositorio creado:', result);
                console.log('üîç Informaci√≥n disponible en: window.BLOCKHUB_LAST_REPOSITORY');
                console.log('üìã Detalles del Token ID:');
                console.log('  Token ID recibido:', result.tokenId);
                console.log('  CID original:', result.originalCID || currentFileHash);
                console.log('  ¬øEs el CID?:', result.tokenId === currentFileHash);
                
                // Mensaje de √©xito m√°s informativo
                if (result.note) {
                    showStatus(`‚úÖ Repositorio "${repoName}" creado! ${result.note}`, 'success');
                } else {
                    showStatus(`‚úÖ Repositorio "${repoName}" creado exitosamente! Token ID: ${result.tokenId}`, 'success');
                }
                
                // Actualizar UI
                updateRepositoryInfo(repoInfo);
                
            } catch (error) {
                console.error('Error creando repositorio:', error);
                showStatus(`Error creando repositorio: ${error.message}`, 'error');
            } finally {
                createRepoBtn.disabled = false;
                createRepoBtn.innerHTML = 'üöÄ Crear Repositorio';
            }
        }

        function updateRepositoryInfo(repoInfo) {
            // Agregar informaci√≥n del repositorio a la UI
            const repoInfoDiv = document.createElement('div');
            repoInfoDiv.className = 'status-message status-success';
            repoInfoDiv.style.marginTop = '1rem';
            
            // Verificar si el token ID es realmente el CID
            const isCID = repoInfo.tokenId && repoInfo.tokenId.startsWith('Qm');
            const tokenDisplay = isCID ? 
                `üîó ${repoInfo.tokenId.substring(0, 10)}...` : 
                `üÜî ${repoInfo.tokenId}`;
            
            repoInfoDiv.innerHTML = `
                <strong>üéâ Repositorio Creado!</strong><br>
                üìÅ Nombre: ${repoInfo.name}<br>
                ${tokenDisplay}<br>
                üîó IPFS: ${repoInfo.ipfsCID ? repoInfo.ipfsCID.substring(0, 10) + '...' : 'N/A'}<br>
                üìÑ TX: ${repoInfo.transactionHash ? repoInfo.transactionHash.substring(0, 10) + '...' : 'N/A'}<br>
                <small style="opacity: 0.8;">
                    ${isCID ? '‚úÖ Token ID es el CID de Pinata' : '‚ö†Ô∏è Verificar Token ID en consola'}
                </small>
            `;
            
            // Agregar despu√©s del editor
            const editorArea = document.querySelector('.editor-area');
            
            // Remover info anterior si existe
            const existingInfo = editorArea.querySelector('.repository-info');
            if (existingInfo) {
                existingInfo.remove();
            }
            
            repoInfoDiv.className += ' repository-info';
            editorArea.appendChild(repoInfoDiv);
        }

        function updateFileName() {
            const name = fileNameInput.value.trim();
            const type = fileTypeSelect.value;
            
            if (name) {
                // Asegurar que tenga la extensi√≥n correcta
                const extensions = {
                    javascript: '.js',
                    typescript: '.ts',
                    solidity: '.sol',
                    json: '.json',
                    markdown: '.md',
                    text: '.txt',
                    html: '.html',
                    css: '.css'
                };
                
                const ext = extensions[type];
                const finalName = name.endsWith(ext) ? name : name + ext;
                currentFileName = finalName;
                currentFileNameEl.textContent = finalName;
                saveFileBtn.disabled = false;
            } else {
                currentFileName = 'nuevo-archivo.js';
                currentFileNameEl.textContent = 'Nuevo archivo';
                saveFileBtn.disabled = true;
            }
        }

        // === FUNCIONES DE HISTORIAL DE COMMITS ===

        // Cargar historial de commits del repositorio actual
        async function loadCommitHistory(tokenId) {
            const commitList = document.getElementById('commitList');
            const commitHistoryHeader = document.getElementById('commitHistoryHeader');
            
            try {
                console.log(`üìã Cargando historial de commits para repositorio ${tokenId}...`);
                
                // Mostrar estado de carga
                commitList.innerHTML = `
                    <div style="text-align: center; color: var(--text-muted); padding: 2rem;">
                        üîÑ Cargando historial de commits...
                    </div>
                `;
                
                // Verificar conexi√≥n Web3
                if (!window.blockHubWeb3 || !window.blockHubWeb3.repoFactoryContract) {
                    throw new Error('Web3 no conectado o contrato no disponible');
                }
                
                // Llamar retrieveCommits del contrato
                const commitsData = await window.blockHubWeb3.repoFactoryContract.retrieveCommits(tokenId);
                console.log('üì• Datos de commits recibidos:', commitsData);
                
                // Destructurar los arrays retornados (incluyendo commitCIDs)
                const [messages, timestamps, committers, statuses, commitCIDs] = commitsData;
                
                console.log('üìã Arrays destructurados:', {
                    messages: messages.length,
                    timestamps: timestamps.length,
                    committers: committers.length,
                    statuses: statuses.length,
                    commitCIDs: commitCIDs ? commitCIDs.length : 'No disponible'
                });
                
                // Convertir a formato manejable
                const commits = [];
                for (let i = 0; i < messages.length; i++) {
                    const status = parseInt(statuses[i].toString());
                    const timestamp = parseInt(timestamps[i].toString());
                    const cid = commitCIDs && commitCIDs[i] ? commitCIDs[i] : null;
                    
                    commits.push({
                        index: i,
                        message: messages[i],
                        timestamp: timestamp,
                        timestampDate: new Date(timestamp * 1000),
                        committer: committers[i],
                        status: status,
                        statusText: status === 0 ? 'pending' : status === 1 ? 'approved' : 'rejected',
                        cid: cid
                    });
                }
                
                // Almacenar commits globalmente para acceso desde loadCommitFile
                window.COMMIT_HISTORY = commits;
                
                console.log(`üìã Total commits encontrados: ${commits.length}`);
                
                // Mostrar header con informaci√≥n del repositorio
                if (window.COMMIT_MODE && window.COMMIT_MODE.active) {
                    document.getElementById('repositoryName').textContent = `üìÇ ${window.COMMIT_MODE.repoName} (Token: ${tokenId})`;
                    commitHistoryHeader.style.display = 'block';
                }
                
                // Renderizar commits (orden cronol√≥gico inverso: m√°s recientes primero)
                if (commits.length === 0) {
                    commitList.innerHTML = `
                        <div style="text-align: center; color: var(--text-muted); padding: 2rem;">
                            üìù No hay commits en este repositorio<br>
                            <small>S√© el primero en hacer un commit</small>
                        </div>
                    `;
                } else {
                    const commitsHtml = commits.reverse().map(commit => `
                        <div class="commit-item ${commit.statusText}" onclick="loadCommitFile(${commit.index}, '${commit.message.replace(/'/g, "\\'")}')">
                            <div class="commit-header">
                                <span class="commit-status ${commit.statusText}">
                                    ${commit.statusText === 'pending' ? '‚è≥ Pendiente' : 
                                      commit.statusText === 'approved' ? '‚úÖ Aprobado' : 'üö´ Rechazado'}
                                </span>
                                <span style="font-size: 0.8rem; color: var(--text-muted);">
                                    Commit #${commit.index}
                                </span>
                            </div>
                            <div class="commit-message">üí¨ ${commit.message}</div>
                            <div class="commit-meta">
                                <span>üë§ ${commit.committer.substring(0, 10)}...</span>
                                <span>üìÖ ${commit.timestampDate.toLocaleDateString()}</span>
                                <span style="font-family: monospace; ${commit.cid ? 'color: var(--secondary-color)' : 'color: var(--text-muted)'}">
                                    ${commit.cid ? `üîó ${commit.cid.substring(0, 6)}...${commit.cid.substring(commit.cid.length - 4)}` : '‚ö†Ô∏è Sin CID'}
                                </span>
                            </div>
                        </div>
                    `).join('');
                    
                    commitList.innerHTML = commitsHtml;
                }
                
            } catch (error) {
                console.error('‚ùå Error cargando historial de commits:', error);
                commitList.innerHTML = `
                    <div style="text-align: center; color: var(--text-muted); padding: 2rem;">
                        ‚ùå Error cargando commits<br>
                        <small>${error.message}</small>
                    </div>
                `;
            }
        }

        // Cargar archivo espec√≠fico de un commit
        async function loadCommitFile(commitIndex, commitMessage) {
            try {
                if (!window.COMMIT_MODE || !window.COMMIT_MODE.active) {
                    alert('‚ùå Funci√≥n solo disponible en modo commit');
                    return;
                }
                
                console.log(`üìÇ Cargando archivo del commit #${commitIndex}: ${commitMessage}`);
                
                // Buscar el commit espec√≠fico en el historial almacenado
                let commitCid = null;
                let commitFound = false;
                
                if (window.COMMIT_HISTORY && window.COMMIT_HISTORY.length > 0) {
                    const commit = window.COMMIT_HISTORY.find(c => c.index === commitIndex);
                    
                    if (commit) {
                        commitFound = true;
                        commitCid = commit.cid;
                        
                        console.log(`üîç Commit encontrado en historial:`, {
                            index: commit.index,
                            message: commit.message,
                            cid: commit.cid,
                            status: commit.statusText
                        });
                        
                        if (commitCid) {
                            console.log(`‚úÖ Usando CID espec√≠fico del commit: ${commitCid}`);
                            showStatus(`üìÇ Cargando archivo espec√≠fico del commit #${commitIndex}...`, 'info');
                        } else {
                            console.log(`‚ö†Ô∏è Commit #${commitIndex} no tiene CID espec√≠fico`);
                        }
                    }
                }
                
                // Si no se encontr√≥ en el historial o no tiene CID, usar fallback
                if (!commitFound || !commitCid) {
                    console.log('‚ö†Ô∏è Usando CID original como fallback');
                    commitCid = window.COMMIT_MODE.originalCid;
                    showStatus(`‚ö†Ô∏è Usando archivo base del repositorio (CID espec√≠fico no disponible para commit #${commitIndex})`, 'warning');
                }
                
                console.log(`üîó Cargando desde CID: ${commitCid}`);
                
                const fileData = await loadFromPinata(commitCid);
                
                if (fileData && fileData.content) {
                    codeEditor.value = fileData.content;
                    currentFileName = fileData.fileName || `commit-${commitIndex}.js`;
                    
                    // Actualizar t√≠tulo con informaci√≥n del commit
                    const isSpecificCID = commitCid !== window.COMMIT_MODE.originalCid;
                    if (isSpecificCID) {
                        currentFileNameEl.textContent = `üìã Commit #${commitIndex}: ${commitMessage}`;
                    } else {
                        currentFileNameEl.textContent = `üìã Commit #${commitIndex}: ${commitMessage} (archivo base)`;
                    }
                    
                    // Actualizar hash global
                    window.BLOCKHUB_CURRENT_FILE_HASH = commitCid;
                    
                    // Marcar visualmente el commit activo
                    markActiveCommit(commitIndex);
                    
                    const statusText = isSpecificCID ? 
                        `‚úÖ Archivo espec√≠fico del commit #${commitIndex} cargado` :
                        `‚ö†Ô∏è Archivo base cargado para commit #${commitIndex}`;
                    
                    showStatus(statusText, isSpecificCID ? 'success' : 'warning');
                    
                    console.log(`‚úÖ Commit #${commitIndex} cargado:`, {
                        message: commitMessage,
                        cid: commitCid,
                        fileName: currentFileName,
                        isSpecificCID: isSpecificCID,
                        foundInHistory: commitFound
                    });
                } else {
                    showStatus('‚ö†Ô∏è No se pudo cargar el contenido del commit', 'warning');
                }
                
            } catch (error) {
                console.error('‚ùå Error cargando archivo del commit:', error);
                showStatus(`‚ùå Error cargando commit: ${error.message}`, 'error');
            }
        }

        // Marcar visualmente el commit activo
        function markActiveCommit(activeIndex) {
            // Remover clase active de todos los commits
            document.querySelectorAll('.commit-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Agregar clase active al commit seleccionado
            const activeCommit = document.querySelector(`[onclick*="loadCommitFile(${activeIndex}"]`);
            if (activeCommit) {
                activeCommit.classList.add('active');
            }
        }

        // Actualizar historial de commits
        function refreshCommitHistory() {
            if (window.COMMIT_MODE && window.COMMIT_MODE.active) {
                loadCommitHistory(window.COMMIT_MODE.tokenId);
            }
        }

        // Funci√≥n legacy para compatibilidad (puede ser removida)
        function updateFileList() {
            // Esta funci√≥n ahora no hace nada, reemplazada por loadCommitHistory
            console.log('üìã updateFileList reemplazada por loadCommitHistory');
        }

        function saveFileToLocalStorage(name, hash) {
            const fileEntry = {
                name: name,
                hash: hash,
                timestamp: Date.now(),
                date: new Date().toLocaleString()
            };
            
            // Evitar duplicados
            savedFiles = savedFiles.filter(f => f.hash !== hash);
            savedFiles.unshift(fileEntry);
            
            // Limitar a los √∫ltimos 20 archivos
            if (savedFiles.length > 20) {
                savedFiles = savedFiles.slice(0, 20);
            }
            
            localStorage.setItem('blockhub_files', JSON.stringify(savedFiles));
            updateFileList();
        }

        // Pinata Functions
        async function uploadToPinata(content, fileName) {
            try {
                console.log('üîç Verificando Pinata Service...');
                console.log('üîß window.pinataService:', !!window.pinataService);
                console.log('‚öôÔ∏è isConfigured:', window.pinataService?.isConfigured);
                
                // Verificar si Pinata est√° configurado
                if (window.pinataService && window.pinataService.isConfigured) {
                    showStatus('üì§ Subiendo archivo a Pinata IPFS...', 'info');
                    
                    console.log('üì§ Llamando window.pinataService.uploadFile...');
                    const result = await window.pinataService.uploadFile(content, fileName);
                    console.log('üì• Resultado de Pinata:', result);
                    
                    if (result && result.hash) {
                        return result.hash;
                    } else {
                        console.error('‚ùå Resultado de Pinata no v√°lido:', result);
                        throw new Error('Pinata no retorn√≥ un hash v√°lido');
                    }
                } else {
                    // Modo simulaci√≥n cuando Pinata no est√° configurado
                    showStatus('‚ö†Ô∏è Pinata no configurado. Usando almacenamiento local...', 'info');
                    
                    // Simular delay de upload
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    
                    // Generar un hash simulado
                    const simulatedHash = 'Qm' + Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
                    
                    // Guardar en localStorage como backup
                    localStorage.setItem(`blockhub_file_${simulatedHash}`, JSON.stringify({
                        content: content,
                        fileName: fileName,
                        timestamp: Date.now()
                    }));
                    
                    return simulatedHash;
                }
                
            } catch (error) {
                console.error('Error uploading to Pinata:', error);
                throw error;
            }
        }

        async function loadFromPinata(hash) {
            try {
                console.log(`üîç Intentando cargar archivo con hash: ${hash}`);
                
                // Intentar cargar desde IPFS usando Pinata
                if (window.pinataService && window.pinataService.isConfigured) {
                    try {
                        console.log('üì° Cargando desde IPFS...');
                        const content = await window.pinataService.loadFile(hash);
                        console.log('‚úÖ Archivo cargado exitosamente desde IPFS');
                        return {
                            content: content,
                            fileName: `archivo-${hash.substring(0, 8)}.txt`
                        };
                    } catch (pinataError) {
                        console.warn('‚ö†Ô∏è Error cargando desde IPFS, intentando almacenamiento local:', pinataError.message);
                        
                        // Mostrar error espec√≠fico al usuario
                        if (pinataError.message.includes('gateway')) {
                            showStatus('‚ö†Ô∏è Problema de conectividad con IPFS. Intentando alternativas...', 'info');
                        }
                    }
                } else {
                    console.log('‚ö†Ô∏è Pinata no configurado, usando almacenamiento local');
                }
                
                // Cargar desde localStorage (backup o modo local)
                console.log('üíæ Buscando en almacenamiento local...');
                const localFile = localStorage.getItem(`blockhub_file_${hash}`);
                if (localFile) {
                    try {
                        const fileData = JSON.parse(localFile);
                        console.log('‚úÖ Archivo encontrado en almacenamiento local');
                        return {
                            content: fileData.content,
                            fileName: fileData.fileName
                        };
                    } catch (parseError) {
                        console.error('‚ùå Error parseando archivo local:', parseError);
                        throw new Error('Archivo corrupto en almacenamiento local');
                    }
                }
                
                // Si llegamos aqu√≠, el archivo no se encontr√≥ en ning√∫n lado
                const errorMsg = `Archivo no encontrado. Hash: ${hash.substring(0, 12)}...`;
                console.error('‚ùå', errorMsg);
                throw new Error(errorMsg);
                
            } catch (error) {
                // Si el error ya fue lanzado por nosotros, no lo envolvemos
                if (error.message.includes('Archivo no encontrado') || 
                    error.message.includes('Archivo corrupto')) {
                    throw error;
                }
                
                // Para otros errores, los envolvemos con m√°s contexto
                console.error('üî• Error general cargando archivo:', error);
                throw new Error(`Error cargando archivo: ${error.message}`);
            }
        }

        // Funci√≥n para probar conectividad IPFS
        async function testIPFSConnectivity() {
            const testHash = 'QmTz3oc4gdpRMKP2sdGUPZBuBXZJUhKv4L5zB4m4j7N7e2'; // Hash p√∫blico de prueba
            
            try {
                testConnBtn.disabled = true;
                testConnBtn.innerHTML = 'üîÑ Probando...';
                showStatus('üîç Probando conectividad con IPFS...', 'info');
                
                if (window.pinataService && window.pinataService.isConfigured) {
                    await window.pinataService.loadFile(testHash);
                    showStatus('‚úÖ ¬°Conectividad IPFS exitosa! Los archivos se pueden cargar correctamente.', 'success');
                } else {
                    showStatus('‚ö†Ô∏è Pinata no est√° configurado. Solo funcionar√° el almacenamiento local.', 'info');
                }
                
            } catch (error) {
                console.error('Error en test de conectividad:', error);
                showStatus(`‚ùå Problema de conectividad: ${error.message}`, 'error');
            } finally {
                testConnBtn.disabled = false;
                testConnBtn.innerHTML = 'üîç Probar Conectividad IPFS';
            }
        }

        // Event Handlers
        async function handleSaveFile() {
            const content = codeEditor.value.trim();
            if (!content) {
                showStatus('El archivo est√° vac√≠o', 'error');
                return;
            }

            try {
                saveFileBtn.disabled = true;
                saveFileBtn.innerHTML = '<span class="loading"></span>Guardando...';
                
                const hash = await uploadToPinata(content, currentFileName);
                
                currentFileHash = hash;
                window.BLOCKHUB_CURRENT_FILE_HASH = hash; // Variable accesible desde consola
                
                saveFileToLocalStorage(currentFileName, hash);
                
                // Habilitar bot√≥n de crear repositorio si Web3 est√° conectado
                if (web3Connected) {
                    createRepoBtn.disabled = false;
                } else {
                    // Check if Web3 can be connected
                    checkWeb3Connection().then(connected => {
                        if (connected) {
                            createRepoBtn.disabled = false;
                        }
                    });
                }
                
                showStatus(`‚úÖ Archivo guardado exitosamente en IPFS: ${hash}`, 'success');
                console.log('üìÅ Archivo guardado - Hash IPFS:', hash);
                console.log('üîç Accede al hash desde: window.BLOCKHUB_CURRENT_FILE_HASH');
                
            } catch (error) {
                showStatus(`Error al guardar: ${error.message}`, 'error');
            } finally {
                saveFileBtn.disabled = false;
                saveFileBtn.innerHTML = 'üíæ Guardar en IPFS';
            }
        }

        async function handleLoadFile() {
            const hash = ipfsHashInput.value.trim();
            if (!hash) {
                showStatus('Ingresa un hash IPFS v√°lido', 'error');
                return;
            }

            try {
                loadFileBtn.disabled = true;
                loadFileBtn.innerHTML = '<span class="loading"></span>Cargando...';
                
                const fileData = await loadFromPinata(hash);
                
                codeEditor.value = fileData.content;
                currentFileName = fileData.fileName;
                currentFileHash = hash;
                window.BLOCKHUB_CURRENT_FILE_HASH = hash;
                
                currentFileNameEl.textContent = fileData.fileName;
                ipfsHashInput.value = '';
                
                showStatus(`‚úÖ Archivo cargado desde IPFS: ${hash}`, 'success');
                
            } catch (error) {
                showStatus(`Error al cargar: ${error.message}`, 'error');
            } finally {
                loadFileBtn.disabled = false;
                loadFileBtn.innerHTML = 'Cargar Archivo';
            }
        }

        function handleNewFile() {
            codeEditor.value = '';
            currentFileName = 'nuevo-archivo.js';
            currentFileHash = null;
            window.BLOCKHUB_CURRENT_FILE_HASH = null;
            currentFileNameEl.textContent = 'Nuevo archivo';
            fileNameInput.value = '';
            saveFileBtn.disabled = true;
        }

        function handleCreateFile() {
            const name = fileNameInput.value.trim();
            if (!name) {
                showStatus('Ingresa un nombre para el archivo', 'error');
                return;
            }
            
            updateFileName();
            codeEditor.focus();
            showStatus(`Archivo "${currentFileName}" creado. ¬°Comienza a escribir!`, 'success');
        }

        async function loadFileFromList(hash, name) {
            try {
                const fileData = await loadFromPinata(hash);
                codeEditor.value = fileData.content;
                currentFileName = name;
                currentFileHash = hash;
                window.BLOCKHUB_CURRENT_FILE_HASH = hash;
                currentFileNameEl.textContent = name;
                
                // Marcar como activo
                document.querySelectorAll('.file-item').forEach(item => item.classList.remove('active'));
                event.currentTarget.classList.add('active');
                
                showStatus(`Archivo "${name}" cargado`, 'success');
            } catch (error) {
                showStatus(`Error al cargar archivo: ${error.message}`, 'error');
            }
        }

        // Event Listeners
        fileNameInput.addEventListener('input', updateFileName);
        fileTypeSelect.addEventListener('change', updateFileName);
        createFileBtn.addEventListener('click', handleCreateFile);
        saveFileBtn.addEventListener('click', handleSaveFile);
        createRepoBtn.addEventListener('click', createBlockchainRepository);
        loadFileBtn.addEventListener('click', handleLoadFile);
        newFileBtn.addEventListener('click', handleNewFile);
        testConnBtn.addEventListener('click', testIPFSConnectivity);

        // Habilitar guardado cuando hay contenido
        codeEditor.addEventListener('input', () => {
            if (currentFileName !== 'Nuevo archivo' && codeEditor.value.trim()) {
                saveFileBtn.disabled = false;
            }
        });

        // Keyboard shortcuts
        codeEditor.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                if (!saveFileBtn.disabled) {
                    handleSaveFile();
                }
            }
        });

        // Navigation Functions
        function handleBackToWallet(event) {
            console.log('üîÑ Intentando navegar a conectar-wallet.html...');
            
            // Si el evento viene de un bot√≥n, prevenir el comportamiento por defecto
            if (event && event.target && event.target.tagName === 'BUTTON') {
                event.preventDefault();
            }
            
            // Lista de rutas a intentar
            const routes = [
                'conectar-wallet.html',
                './conectar-wallet.html',
                '../conectar-wallet.html',
                '/conectar-wallet.html'
            ];
            
            // Funci√≥n para verificar si un archivo existe
            async function checkFileExists(url) {
                try {
                    const response = await fetch(url, { method: 'HEAD' });
                    return response.ok;
                } catch {
                    return false;
                }
            }
            
            // Intentar cada ruta
            async function tryNavigation() {
                for (const route of routes) {
                    try {
                        console.log(`üîç Probando ruta: ${route}`);
                        
                        // Verificar si el archivo existe
                        const exists = await checkFileExists(route);
                        if (exists) {
                            console.log(`‚úÖ Archivo encontrado: ${route}`);
                            window.location.href = route;
                            return true;
                        } else {
                            console.log(`‚ùå Archivo no encontrado: ${route}`);
                        }
                    } catch (error) {
                        console.log(`‚ùå Error con ruta ${route}:`, error.message);
                    }
                }
                return false;
            }
            
            // Ejecutar navegaci√≥n
            tryNavigation().then(success => {
                if (!success) {
                    console.error('‚ùå No se pudo encontrar conectar-wallet.html');
                    
                    // Mostrar opciones al usuario
                    const userChoice = confirm(
                        'No se pudo encontrar la p√°gina conectar-wallet.html.\n\n' +
                        '¬øQuieres ir a la p√°gina principal (index.html) en su lugar?\n\n' +
                        'Presiona OK para ir a index.html o Cancelar para quedarte aqu√≠.'
                    );
                    
                    if (userChoice) {
                        try {
                            window.location.href = 'index.html';
                        } catch (error) {
                            alert('Error: No se pudo navegar. Intenta refrescar la p√°gina o navegar manualmente.');
                        }
                    }
                }
            });
            
            // Si es un enlace, prevenir navegaci√≥n por defecto hasta verificar
            if (event && event.target && event.target.tagName === 'A') {
                event.preventDefault();
                return false;
            }
        }

        // Funci√≥n simple de navegaci√≥n como fallback
        function goToWallet() {
            console.log('üîÑ Navegaci√≥n simple a wallet...');
            try {
                window.location = 'conectar-wallet.html';
            } catch (error) {
                try {
                    window.open('conectar-wallet.html', '_self');
                } catch (error2) {
                    window.location.replace('conectar-wallet.html');
                }
            }
        }
        
        // Hacer funci√≥n disponible globalmente para debug
        window.goToWallet = goToWallet;

        // Initialize
        updateFileList();
        showStatus('üîÑ Verificando conexi√≥n de wallet...', 'info');
        
        // Verificar si Web3 ya est√° conectado desde la p√°gina de wallet
        setTimeout(async () => {
            console.log('üîç Verificando estado de conexi√≥n Web3...');
            const connected = await checkWeb3Connection();
            
            if (connected) {
                console.log('‚úÖ Wallet conectado desde p√°gina anterior');
            } else {
                console.log('‚ö†Ô∏è Wallet no conectado - usuario debe ir a p√°gina de wallet');
                showStatus('üí° Ve a la p√°gina de Wallet para conectar MetaMask', 'info');
            }
        }, 1000);
        
        // Funci√≥n para navegar a colaboradores
        function goToCollaborators() {
            console.log('ü§ù Navegando a colaboradores.html...');
            
            const routes = [
                'colaboradores.html',
                './colaboradores.html',
                '../colaboradores.html',
                '/colaboradores.html'
            ];
            
            // Intentar cada ruta
            function tryRoute(index) {
                if (index >= routes.length) {
                    alert('‚ùå No se pudo encontrar la p√°gina de colaboradores. Aseg√∫rate de que colaboradores.html est√© en el mismo directorio.');
                    return;
                }
                
                const route = routes[index];
                console.log(`üîç Probando ruta: ${route}`);
                
                try {
                    window.location.href = route;
                } catch (error) {
                    console.log(`‚ùå Error con ruta ${route}:`, error.message);
                    tryRoute(index + 1);
                }
            }
            
            tryRoute(0);
        }

        // Detectar modo commit desde par√°metros URL
        function checkCommitMode() {
            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('mode');
            
            if (mode === 'commit') {
                const tokenId = urlParams.get('tokenId');
                const cid = urlParams.get('cid');
                const repoName = urlParams.get('repoName');
                const owner = urlParams.get('owner');
                
                console.log('üîÑ Modo COMMIT detectado:', { tokenId, cid, repoName, owner });
                
                if (tokenId && cid && repoName) {
                    setupCommitMode(tokenId, cid, repoName, owner);
                } else {
                    console.error('‚ùå Par√°metros de commit incompletos');
                }
            }
        }

        // Configurar interfaz para modo commit
        function setupCommitMode(tokenId, cid, repoName, owner) {
            console.log(`üîß Configurando modo commit para: ${repoName} (Token: ${tokenId})`);
            console.log(`üë§ Due√±o del repositorio: ${owner}`);
            
            // Cambiar t√≠tulo y estado del editor
            document.title = `BlockHub - Commit: ${repoName}`;
            const titleElement = document.querySelector('.logo h1');
            if (titleElement) {
                titleElement.textContent = `Editor de Archivos IPFS - Commit: ${repoName}`;
            }
            
            // Agregar indicador visual prominente de modo commit
            const header = document.querySelector('.header');
            if (header) {
                const commitBanner = document.createElement('div');
                commitBanner.id = 'commitModeBanner';
                commitBanner.style.cssText = `
                    background: linear-gradient(45deg, #ff6b00, #ff8c00);
                    color: white;
                    padding: 10px;
                    text-align: center;
                    font-weight: bold;
                    font-size: 1.1rem;
                    box-shadow: 0 2px 10px rgba(255, 107, 0, 0.3);
                    animation: pulse 2s infinite;
                `;
                commitBanner.innerHTML = `üîÑ MODO COMMIT ACTIVO - Repositorio: ${repoName} (Token: ${tokenId}) üîÑ`;
                header.parentNode.insertBefore(commitBanner, header.nextSibling);
            }
            
            // Agregar estilo de animaci√≥n para el banner
            const style = document.createElement('style');
            style.textContent = `
                @keyframes pulse {
                    0%, 100% { opacity: 1; }
                    50% { opacity: 0.8; }
                }
            `;
            document.head.appendChild(style);
            
            // Ocultar botones que no son necesarios en modo commit
            const createRepoBtn = document.getElementById('createRepoBtn');
            if (createRepoBtn) {
                createRepoBtn.style.display = 'none';
            }
            
            const viewReposBtn = document.getElementById('viewReposBtn');
            if (viewReposBtn) {
                viewReposBtn.style.display = 'none';
            }
            
            // Modificar el bot√≥n de guardar para que sea "Hacer Commit"
            const saveFileBtn = document.getElementById('saveFileBtn');
            if (saveFileBtn) {
                saveFileBtn.innerHTML = 'üöÄ Hacer Commit';
                saveFileBtn.onclick = () => handleCommitSave(tokenId, cid, repoName);
                saveFileBtn.style.background = 'linear-gradient(45deg, #ff6b00, #ff8c00)';
                saveFileBtn.style.color = 'white';
            }
            
            // Agregar bot√≥n para volver a colaboradores
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                const backToCollabBtn = document.createElement('button');
                backToCollabBtn.className = 'btn btn-secondary';
                backToCollabBtn.style.cssText = 'width: 100%; margin-top: 0.5rem; background: linear-gradient(45deg, #00aa88, #00ffaa); color: #000;';
                backToCollabBtn.innerHTML = '‚Üê Volver a Colaboradores';
                backToCollabBtn.onclick = () => {
                    if (confirm('¬øQuieres volver a colaboradores? Se perder√°n los cambios no guardados.')) {
                        window.location.href = 'colaboradores.html';
                    }
                };
                sidebar.appendChild(backToCollabBtn);
                
                // Agregar bot√≥n para depositar fondos (solo para due√±os)
                if (isRepoOwner()) {
                    const depositBtn = document.createElement('button');
                    depositBtn.className = 'btn btn-primary';
                    depositBtn.style.cssText = 'width: 100%; margin-top: 0.5rem; background: linear-gradient(45deg, #ff6b00, #ff8c00); color: white;';
                    depositBtn.innerHTML = 'üí∞ Depositar ETH (Due√±o)';
                    depositBtn.onclick = () => showDepositModal();
                    sidebar.appendChild(depositBtn);
                } else {
                    // Mensaje informativo para no-due√±os
                    const infoDiv = document.createElement('div');
                    infoDiv.style.cssText = 'margin-top: 0.5rem; padding: 0.5rem; background: #f0f0f0; border-radius: 5px; font-size: 0.9rem; color: #666;';
                    infoDiv.innerHTML = 'üí° Solo el due√±o puede depositar ETH';
                    sidebar.appendChild(infoDiv);
                }
            }
            
            // Cargar archivo del repositorio autom√°ticamente
            loadRepositoryFile(cid);
            
            // Cargar historial de commits del repositorio
            setTimeout(() => {
                loadCommitHistory(tokenId);
            }, 1000);
            
            // Mostrar informaci√≥n del repositorio
            showStatus(`üìù Modo Commit activado para: ${repoName} (Token: ${tokenId})`, 'info');
            
            // Guardar datos del commit en variables globales
            window.COMMIT_MODE = {
                active: true,
                tokenId: tokenId,
                originalCid: cid,
                repoName: repoName,
                owner: owner
            };
        }

        // Cargar archivo del repositorio para editar
        async function loadRepositoryFile(cid) {
            try {
                showStatus('üì• Cargando archivo del repositorio...', 'info');
                
                const fileData = await loadFromPinata(cid);
                
                if (fileData && fileData.content) {
                    codeEditor.value = fileData.content;
                    currentFileName = fileData.fileName || 'archivo-repo.js';
                    currentFileNameEl.textContent = `Editando: ${currentFileName}`;
                    
                    showStatus(`‚úÖ Archivo cargado: ${currentFileName}`, 'success');
                    
                    // Habilitar bot√≥n de commit
                    const saveFileBtn = document.getElementById('saveFileBtn');
                    if (saveFileBtn) {
                        saveFileBtn.disabled = false;
                    }
                } else {
                    showStatus('‚ö†Ô∏è No se pudo cargar el contenido del archivo', 'warning');
                }
                
            } catch (error) {
                console.error('‚ùå Error cargando archivo del repositorio:', error);
                showStatus(`‚ùå Error cargando archivo: ${error.message}`, 'error');
            }
        }

        // Manejar guardado como commit
        async function handleCommitSave(tokenId, originalCid, repoName) {
            try {
                if (!window.COMMIT_MODE || !window.COMMIT_MODE.active) {
                    console.error('‚ùå Modo commit no activo');
                    return;
                }
                
                // Solicitar mensaje de commit
                const commitMessage = prompt('üí¨ Mensaje del commit:', 'Actualizaci√≥n de archivo');
                if (!commitMessage) {
                    showStatus('‚ùå Commit cancelado: se requiere un mensaje', 'error');
                    return;
                }
                
                showStatus('üì§ Subiendo archivo modificado...', 'info');
                
                // 1. Subir archivo modificado a IPFS
                const content = codeEditor.value;
                
                console.log('üì§ Preparando archivo para subir...');
                console.log('üìù Contenido:', content.substring(0, 100) + '...');
                console.log('üìÅ Nombre archivo:', currentFileName);
                
                let newCid;
                try {
                    newCid = await uploadToPinata(content, currentFileName);
                    if (!newCid) {
                        throw new Error('No se obtuvo CID de Pinata');
                    }
                    console.log('‚úÖ Nuevo archivo subido con CID:', newCid);
                } catch (uploadError) {
                    console.error('‚ùå Error detallado en upload:', uploadError);
                    throw new Error(`Error subiendo archivo: ${uploadError.message}`);
                }
                
                showStatus('‚õìÔ∏è Procesando commit en blockchain...', 'info');
                
                // 2. Llamar processNewCommit
                console.log(`üîÑ Llamando processNewCommit(${tokenId}, "${commitMessage}", "${newCid}")`);
                
                if (!window.blockHubWeb3.repoFactoryContract) {
                    throw new Error('Contrato no disponible');
                }
                
                const tx = await window.blockHubWeb3.repoFactoryContract.processNewCommit(
                    tokenId, 
                    commitMessage, 
                    newCid
                );
                
                console.log('‚è≥ Transacci√≥n enviada:', tx.hash);
                showStatus(`‚è≥ Transacci√≥n enviada: ${tx.hash}`, 'info');
                
                const receipt = await tx.wait();
                console.log('‚úÖ Commit confirmado:', receipt);
                
                showStatus(`üéâ ¬°Commit realizado exitosamente! TX: ${receipt.transactionHash}`, 'success');
                
                // Opcional: redirigir de vuelta a colaboradores despu√©s de un tiempo
                setTimeout(() => {
                    if (confirm('¬øQuieres volver a la p√°gina de colaboradores?')) {
                        window.location.href = 'colaboradores.html';
                    }
                }, 3000);
                
            } catch (error) {
                console.error('‚ùå Error en commit:', error);
                showStatus(`‚ùå Error en commit: ${error.message}`, 'error');
            }
        }

        // Verificar si el usuario actual es due√±o del repositorio (modo commit)
        function isRepoOwner() {
            if (!window.COMMIT_MODE || !window.COMMIT_MODE.active) {
                return false;
            }
            
            if (!window.blockHubWeb3) {
                return false;
            }
            
            const accountInfo = window.blockHubWeb3.getAccountInfo();
            if (!accountInfo || !accountInfo.account) {
                return false;
            }
            
            const currentAccount = accountInfo.account.toLowerCase();
            const repoOwner = window.COMMIT_MODE.owner?.toLowerCase();
            
            console.log('üîç Verificando ownership en modo commit...');
            console.log('üë§ Usuario actual:', currentAccount);
            console.log('üëë Due√±o del repo:', repoOwner);
            console.log('üìÇ Repositorio:', window.COMMIT_MODE.tokenId);
            console.log('‚úÖ Es due√±o?:', currentAccount === repoOwner);
            
            return currentAccount === repoOwner;
        }

        // Mostrar modal de dep√≥sito (modo commit)
        function showDepositModal() {
            if (!window.COMMIT_MODE || !window.COMMIT_MODE.active) {
                alert('‚ùå Modal de dep√≥sito solo disponible en modo commit');
                return;
            }
            
            const { tokenId, repoName } = window.COMMIT_MODE;
            const ethAmount = prompt(`üí∞ ¬øCu√°nto ETH quieres depositar al repositorio "${repoName}"?\n\nToken ID: ${tokenId}\nM√≠nimo: 0.0001 ETH`, '0.001');
            
            if (!ethAmount || parseFloat(ethAmount) <= 0) {
                showStatus('‚ùå Dep√≥sito cancelado: cantidad no v√°lida', 'error');
                return;
            }
            
            if (parseFloat(ethAmount) < 0.0001) {
                showStatus('‚ùå Cantidad m√≠nima: 0.0001 ETH', 'error');
                return;
            }
            
            // Confirmar dep√≥sito
            if (!confirm(`¬øConfirmas depositar ${ethAmount} ETH al repositorio "${repoName}"?\n\nEsta transacci√≥n no se puede revertir.`)) {
                showStatus('‚ùå Dep√≥sito cancelado por el usuario', 'warning');
                return;
            }
            
            executeDepositInEditor(tokenId, ethAmount, repoName);
        }

        // Ejecutar dep√≥sito en editor
        async function executeDepositInEditor(tokenId, ethAmount, repoName) {
            try {
                console.log(`üí∞ Iniciando dep√≥sito: ${ethAmount} ETH al repositorio ${tokenId}`);
                
                if (!window.blockHubWeb3 || !window.blockHubWeb3.repoFactoryContract) {
                    throw new Error('Web3 no conectado o contrato no disponible');
                }
                
                showStatus('üí∞ Preparando transacci√≥n de dep√≥sito...', 'info');
                
                const weiAmount = window.ethers.utils.parseEther(ethAmount);
                console.log(`üí∞ Enviando ${ethAmount} ETH (${weiAmount.toString()} Wei)`);
                
                const tx = await window.blockHubWeb3.repoFactoryContract.depositToRepo(
                    tokenId, 
                    { value: weiAmount }
                );
                
                console.log('‚è≥ Transacci√≥n enviada:', tx.hash);
                showStatus(`‚è≥ Transacci√≥n enviada: ${tx.hash}`, 'info');
                
                const receipt = await tx.wait();
                console.log('‚úÖ Dep√≥sito confirmado:', receipt);
                
                // Buscar evento depositedETH
                const depositEvent = receipt.events?.find(e => e.event === 'depositedETH');
                if (depositEvent) {
                    const [repoTokenId, depositor, amount] = depositEvent.args;
                    console.log('üéâ Evento depositedETH:', {
                        tokenId: repoTokenId.toString(),
                        depositor: depositor,
                        amount: window.ethers.utils.formatEther(amount) + ' ETH'
                    });
                }
                
                showStatus(`üéâ ¬°Dep√≥sito exitoso! ${ethAmount} ETH depositados a "${repoName}". TX: ${receipt.transactionHash}`, 'success');
                
            } catch (error) {
                console.error('‚ùå Error en dep√≥sito:', error);
                showStatus(`‚ùå Error en dep√≥sito: ${error.message}`, 'error');
            }
        }

        // Ejecutar verificaci√≥n de modo commit al cargar
        setTimeout(() => {
            checkCommitMode();
        }, 1000);
        
        // Mostrar informaci√≥n en consola
        console.log('üöÄ BlockHub File Editor cargado');
        console.log('üìã Hash del archivo actual disponible en: window.BLOCKHUB_CURRENT_FILE_HASH');
        console.log('üéØ √öltima transacci√≥n de repositorio en: window.BLOCKHUB_LAST_REPOSITORY');
        console.log('üîß Servicio Web3 disponible en: window.blockHubWeb3');

        // Navbar background effect on scroll
        window.addEventListener('scroll', function() {
            const navbar = document.querySelector('.navbar');
            if (window.scrollY > 100) {
                navbar.style.background = 'rgba(0, 0, 0, 0.3)';
            } else {
                navbar.style.background = 'rgba(235, 235, 235, 0.1)';
            }
        });
    </script>
</body>
</html>
