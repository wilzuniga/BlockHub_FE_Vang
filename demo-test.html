<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlockHub - Demo de Creaci√≥n de Repositorios</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            color: #00ff00;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: #000;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #00ff00;
        }

        .step {
            margin: 20px 0;
            padding: 15px;
            background: #0a0a0a;
            border-left: 4px solid #00ff00;
        }

        .code {
            background: #1a1a1a;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 10px 0;
            border: 1px solid #333;
        }

        .success {
            color: #00ff00;
            font-weight: bold;
        }

        .warning {
            color: #ffaa00;
            font-weight: bold;
        }

        .error {
            color: #ff0000;
            font-weight: bold;
        }

        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 5px;
            font-weight: bold;
            margin: 5px;
        }

        button:hover {
            background: #00aa00;
        }

        .demo-section {
            margin: 30px 0;
            padding: 20px;
            background: #0a0a0a;
            border-radius: 10px;
        }

        .step-hint {
            font-size: 0.9rem;
            color: #ffaa00;
            margin-top: 8px;
        }

        .integration-banner {
            border: 1px dashed #00ff00;
            background: #050505;
            border-radius: 10px;
        }

        .integration-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .mini-label {
            font-size: 0.75rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: #aaaaaa;
            margin-bottom: 4px;
        }

        .mini-note {
            font-size: 0.85rem;
            color: #cccccc;
            margin-top: 6px;
        }

        .status-pill {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 999px;
            font-weight: bold;
            font-size: 0.9rem;
            border: 1px solid #00ff00;
            color: #00ff00;
            background: #101010;
        }

        .status-pill[data-state="pending"] {
            border-color: #ffaa00;
            color: #ffaa00;
        }

        .status-pill[data-state="error"] {
            border-color: #ff0000;
            color: #ff5f5f;
        }

        .status-pill[data-state="ready"] {
            border-color: #00ffcc;
            color: #00ffcc;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üöÄ BlockHub - Demo de Creaci√≥n de Repositorios</h1>
        <p>Esta p√°gina demuestra c√≥mo usar la funcionalidad de creaci√≥n de archivos y repositorios en BlockHub.</p>

        <div class="demo-section">
            <h2>üìã Pre-requisitos</h2>
            <div class="step">
                <h3>1. MetaMask Instalado</h3>
                <p id="metamaskStatus" class="warning">Verificando MetaMask...</p>
                <button type="button" onclick="checkMetaMask()">üîç Verificar MetaMask</button>
            </div>

            <div class="step">
                <h3>2. Pinata Configurado</h3>
                <p id="pinataStatus" class="warning">Verificando Pinata...</p>
                <button type="button" onclick="checkPinata()">üîç Verificar Pinata</button>
            </div>

            <div class="step">
                <h3>3. Web3 Service Cargado</h3>
                <p id="web3Status" class="warning">Verificando Web3 Service...</p>
                <button type="button" onclick="checkWeb3Service()">üîç Verificar Web3 Service</button>
            </div>
        </div>

        <div class="demo-section">
            <h2>üîß Demo Paso a Paso</h2>

            <div class="step">
                <h3>Paso 1: Crear Archivo de Ejemplo</h3>
                <p>Vamos a crear un archivo de ejemplo para demostrar el flujo completo.</p>
                <button type="button" onclick="createSampleFile()">üìÑ Crear Archivo de Ejemplo</button>
                <div id="fileOutput" class="code" style="display: none;"></div>
            </div>

            <div class="step">
                <h3>Paso 2: Guardar en IPFS</h3>
                <p>Subir el archivo a IPFS usando Pinata.</p>
                <button type="button" onclick="uploadToIPFS()" disabled id="uploadBtn">üíæ Subir a IPFS</button>
                <div id="ipfsOutput" class="code" style="display: none;"></div>
            </div>

            <div class="step">
                <h3>Paso 3: Conectar Web3</h3>
                <p>Conectar con MetaMask para interactuar con contratos.</p>
                <button type="button" onclick="connectWeb3()" id="connectBtn">ü¶ä Conectar MetaMask</button>
                <div id="web3Output" class="code" style="display: none;"></div>
            </div>

            <div class="step">
                <h3>Paso 4: Crear Repositorio</h3>
                <p>Crear repositorio en blockchain usando el hash IPFS.</p>
                <p class="step-hint">Tip: usa el mismo nombre que aparecer√° en el contrato para identificar tu repo en
                    BlockHub.</p>
                <button type="button" onclick="createRepository()" disabled id="repoBtn">üöÄ Crear Repositorio</button>
                <div id="repoOutput" class="code" style="display: none;"></div>
            </div>
        </div>

        <div class="demo-section">
            <h2>üß© Integraci√≥n con la Interfaz</h2>
            <div class="step integration-banner">
                <p>
                    Esta demo usa el mismo m√≥dulo <code>BlockHubWeb3Service.createRepository</code> que alimenta
                    la vista principal en <a href="colaboradores.html" target="_blank">colaboradores.html</a>.
                    √ösalo para validar contratos antes de conectar la UI principal.
                </p>
                <div class="integration-grid">
                    <div>
                        <p class="mini-label">Estado del m√≥dulo</p>
                        <span id="repoModuleStatus" class="status-pill" data-state="pending">Sincronizando...</span>
                        <p id="repoModuleHint" class="mini-note">Conecta MetaMask para compartir estado con la interfaz.</p>
                    </div>
                    <div>
                        <p class="mini-label">Contratos enlazados</p>
                        <span id="contractSyncStatus" class="status-pill" data-state="pending">Sin datos</span>
                        <p id="contractAddresses" class="mini-note">RepoFactory: -- | POAP: --</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="demo-section">
            <h2>üìä Estado Actual</h2>
            <div class="code">
                <div id="currentState" role="status" aria-live="polite">
                    üìÅ Archivo: No creado<br>
                    üîó IPFS Hash: No disponible<br>
                    ü¶ä Web3: No conectado<br>
                    üìÑ Repositorio: No creado
                </div>
            </div>
            <button type="button" onclick="updateStatus()">üîÑ Actualizar Estado</button>
        </div>

        <div class="demo-section">
            <h2>üîç Informaci√≥n T√©cnica</h2>
            <div class="step">
                <h3>Variables Globales Disponibles</h3>
                <div class="code">
                    // Hash del archivo actual en IPFS
                    window.BLOCKHUB_CURRENT_FILE_HASH

                    // Informaci√≥n del √∫ltimo repositorio creado
                    window.BLOCKHUB_LAST_REPOSITORY

                    // Instancia del servicio Web3
                    window.blockHubWeb3

                    // Servicio de Pinata
                    window.pinataService
                </div>
                <button type="button" onclick="showGlobalVars()">üìã Mostrar Variables</button>
            </div>
        </div>
    </div>

    <!-- Scripts necesarios para la demo -->
    <script src="pinata-config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="web3-contract-integration.js"></script>
    <script src="blockhub-remix-style.js"></script>

    <script>
        // Variables del demo
        let demoFileName = 'demo-contract.sol';
        let demoContent = '';
        let currentHash = null;
        let web3Connected = false;

        const integrationRefs = {
            moduleStatus: document.getElementById('repoModuleStatus'),
            moduleHint: document.getElementById('repoModuleHint'),
            contractStatus: document.getElementById('contractSyncStatus'),
            contractAddresses: document.getElementById('contractAddresses')
        };

        function setPillState(element, state, text) {
            if (!element) return;
            element.dataset.state = state;
            element.textContent = text;
        }

        function setTextContent(element, text) {
            if (element) {
                element.textContent = text;
            }
        }

        function refreshIntegrationBanner() {
            const service = window.blockHubWeb3;
            if (!integrationRefs.moduleStatus) return;

            if (!service) {
                setPillState(integrationRefs.moduleStatus, 'error', 'Servicio no disponible');
                setTextContent(integrationRefs.moduleHint, 'Incluye web3-contract-integration.js para habilitar el m√≥dulo.');
                setPillState(integrationRefs.contractStatus, 'pending', 'Contratos sin registrar');
                setTextContent(integrationRefs.contractAddresses, 'RepoFactory: -- | POAP: --');
                return;
            }

            if (service.isInitialized && web3Connected) {
                setPillState(integrationRefs.moduleStatus, 'ready', 'Listo para crear repositorios');
                setTextContent(integrationRefs.moduleHint, 'Los estados se reflejan tambi√©n en la interfaz principal.');
            } else {
                setPillState(integrationRefs.moduleStatus, 'pending', 'Esperando conexi√≥n de wallet');
                setTextContent(integrationRefs.moduleHint, 'Conecta MetaMask para compartir contexto con la UI.');
            }

            if (service.contracts) {
                setPillState(integrationRefs.contractStatus, 'ready', 'Direcciones detectadas');
                setTextContent(integrationRefs.contractAddresses, `RepoFactory: ${service.contracts.repoFactory || '--'} | POAP: ${service.contracts.poap || '--'}`);
            } else {
                setPillState(integrationRefs.contractStatus, 'pending', 'Contratos no configurados');
                setTextContent(integrationRefs.contractAddresses, 'RepoFactory: -- | POAP: --');
            }
        }

        // Verificaciones iniciales
        function checkMetaMask() {
            const status = document.getElementById('metamaskStatus');
            if (typeof window.ethereum !== 'undefined') {
                status.innerHTML = '<span class="success">‚úÖ MetaMask detectado</span>';
                return true;
            } else {
                status.innerHTML = '<span class="error">‚ùå MetaMask no instalado</span>';
                return false;
            }
        }

        function checkPinata() {
            const status = document.getElementById('pinataStatus');
            if (window.pinataService && window.pinataService.isConfigured) {
                status.innerHTML = '<span class="success">‚úÖ Pinata configurado correctamente</span>';
                return true;
            } else {
                status.innerHTML = '<span class="warning">‚ö†Ô∏è Pinata no configurado (usar√° modo local)</span>';
                return false;
            }
        }

        function checkWeb3Service() {
            const status = document.getElementById('web3Status');
            if (window.blockHubWeb3) {
                status.innerHTML = '<span class="success">‚úÖ Web3 Service cargado</span>';
                refreshIntegrationBanner();
                return true;
            } else {
                status.innerHTML = '<span class="error">‚ùå Web3 Service no disponible</span>';
                refreshIntegrationBanner();
                return false;
            }
        }

        // Funciones del demo
        function createSampleFile() {
            demoContent = `// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

/**
 * @title DemoContract
 * @dev Contrato de demostraci√≥n para BlockHub
 * Creado en: ${new Date().toISOString()}
 */
contract DemoContract {
    string public message;
    address public owner;
    
    constructor(string memory _message) {
        message = _message;
        owner = msg.sender;
    }
    
    function updateMessage(string memory _newMessage) public {
        require(msg.sender == owner, "Solo el propietario puede actualizar");
        message = _newMessage;
    }
    
    function getMessage() public view returns (string memory) {
        return message;
    }
}`;

            const output = document.getElementById('fileOutput');
            output.style.display = 'block';
            output.innerHTML = `<strong>Archivo creado:</strong> ${demoFileName}<br><br>${demoContent.replace(/\n/g, '<br>')}`;

            document.getElementById('uploadBtn').disabled = false;
            updateStatus();
        }

        async function uploadToIPFS() {
            if (!demoContent) {
                alert('Primero crea un archivo de ejemplo');
                return;
            }

            const output = document.getElementById('ipfsOutput');
            output.style.display = 'block';
            output.innerHTML = 'üì§ Subiendo archivo a IPFS...';

            try {
                // Usar el servicio de Pinata
                let hash;
                if (window.pinataService && window.pinataService.isConfigured) {
                    const result = await window.pinataService.uploadFile(demoContent, demoFileName);
                    hash = result.hash;
                } else {
                    // Modo simulaci√≥n
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    hash = 'Qm' + Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);

                    // Guardar en localStorage para simulaci√≥n
                    localStorage.setItem(`blockhub_file_${hash}`, JSON.stringify({
                        content: demoContent,
                        fileName: demoFileName,
                        timestamp: Date.now()
                    }));
                }

                currentHash = hash;
                window.BLOCKHUB_CURRENT_FILE_HASH = hash;

                output.innerHTML = `<span class="success">‚úÖ Archivo subido exitosamente</span><br>
Hash IPFS: ${hash}<br>
Archivo: ${demoFileName}<br>
Tama√±o: ${demoContent.length} bytes`;

                document.getElementById('connectBtn').disabled = false;
                updateStatus();

            } catch (error) {
                output.innerHTML = `<span class="error">‚ùå Error: ${error.message}</span>`;
            }
        }

        async function connectWeb3() {
            const output = document.getElementById('web3Output');
            output.style.display = 'block';
            output.innerHTML = 'üîÑ Conectando con MetaMask...';

            try {
                await window.blockHubWeb3.initializeWeb3();
                web3Connected = true;

                const accountInfo = window.blockHubWeb3.getAccountInfo();
                output.innerHTML = `<span class="success">‚úÖ Web3 conectado exitosamente</span><br>
Cuenta: ${accountInfo.account}<br>
Red: Detectada autom√°ticamente<br>
Contratos: Cargados`;

                document.getElementById('repoBtn').disabled = false;
                updateStatus();
                refreshIntegrationBanner();

            } catch (error) {
                output.innerHTML = `<span class="error">‚ùå Error: ${error.message}</span>`;
                refreshIntegrationBanner();
            }
        }

        async function createRepository() {
            if (!currentHash) {
                alert('Primero sube el archivo a IPFS');
                return;
            }

            if (!web3Connected) {
                alert('Primero conecta MetaMask');
                return;
            }

            const output = document.getElementById('repoOutput');
            output.style.display = 'block';
            output.innerHTML = 'üöÄ Creando repositorio en blockchain...';

            try {
                const repoName = demoFileName.replace(/\.[^/.]+$/, ""); // Remover extensi√≥n

                // Nota: Esto fallar√° hasta que se actualicen las direcciones de contrato
                const result = await window.blockHubWeb3.createRepository(repoName, currentHash);

                window.BLOCKHUB_LAST_REPOSITORY = result;

                output.innerHTML = `<span class="success">‚úÖ Repositorio creado exitosamente</span><br>
Nombre: ${repoName}<br>
Token ID: ${result.tokenId}<br>
Hash TX: ${result.transactionHash}<br>
IPFS CID: ${currentHash}`;

                updateStatus();
                refreshIntegrationBanner();

            } catch (error) {
                if (error.message.includes('0x0000000000000000000000000000000000000000')) {
                    output.innerHTML = `<span class="warning">‚ö†Ô∏è Contratos no desplegados</span><br>
Las direcciones de contrato est√°n en modo placeholder.<br>
Actualiza las direcciones en web3-contract-integration.js<br>
Error: ${error.message}`;
                } else {
                    output.innerHTML = `<span class="error">‚ùå Error: ${error.message}</span>`;
                }
                refreshIntegrationBanner();
            }
        }

        function updateStatus() {
            const statusDiv = document.getElementById('currentState');
            const fileStatus = demoContent ? `‚úÖ ${demoFileName}` : '‚ùå No creado';
            const ipfsStatus = currentHash ? `‚úÖ ${currentHash.substring(0, 10)}...` : '‚ùå No disponible';
            const web3Status = web3Connected ? '‚úÖ Conectado' : '‚ùå No conectado';
            const repoStatus = window.BLOCKHUB_LAST_REPOSITORY ? '‚úÖ Creado' : '‚ùå No creado';

            statusDiv.innerHTML = `
üìÅ Archivo: ${fileStatus}<br>
üîó IPFS Hash: ${ipfsStatus}<br>
ü¶ä Web3: ${web3Status}<br>
üìÑ Repositorio: ${repoStatus}
            `;
        }

        function showGlobalVars() {
            const vars = {
                'BLOCKHUB_CURRENT_FILE_HASH': window.BLOCKHUB_CURRENT_FILE_HASH || 'undefined',
                'BLOCKHUB_LAST_REPOSITORY': window.BLOCKHUB_LAST_REPOSITORY || 'undefined',
                'blockHubWeb3': window.blockHubWeb3 ? 'object disponible' : 'undefined',
                'pinataService': window.pinataService ? 'object disponible' : 'undefined'
            };

            console.log('üîç Variables Globales de BlockHub:', vars);
            alert('Variables mostradas en la consola. Abre DevTools para verlas.');
        }

        // Inicializaci√≥n
        window.addEventListener('load', () => {
            setTimeout(() => {
                checkMetaMask();
                checkPinata();
                checkWeb3Service();
                updateStatus();
                refreshIntegrationBanner();
            }, 1000);
        });
    </script>
</body>

</html>